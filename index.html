<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SacIND - Novel Platform</title>
    <style>
        :root {
            --primary: #e74c3c;
            --secondary: #2c3e50;
            --light: #ecf0f1;
            --dark: #222;
            --background: #f9f9f9;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: var(--background);
            color: var(--dark);
        }
        
        header {
            background-color: var(--secondary);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            color: var(--primary);
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .search-bar {
            display: flex;
            width: 50%;
        }
        
        .search-bar input {
            width: 100%;
            padding: 10px 15px;
            border: none;
            border-radius: 25px 0 0 25px;
            font-size: 0.9rem;
            outline: none;
        }
        
        .search-bar button {
            padding: 10px 15px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 0 25px 25px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .search-bar button:hover {
            background-color: #c0392b;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .donate-btn, .bookmark-btn, .popular-btn {
            padding: 8px 15px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .donate-btn:hover, .bookmark-btn:hover, .popular-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Popular Novels Dropdown */
        .popular-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .popular-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 300px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .popular-dropdown:hover .popular-content {
            display: block;
        }
        
        .popular-novel {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .popular-novel:hover {
            background-color: #f5f5f5;
        }
        
        .popular-novel-cover {
            width: 50px;
            height: 70px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .popular-novel-info {
            flex: 1;
        }
        
        .popular-novel-title {
            font-weight: bold;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .popular-novel-author {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        
        .popular-novel-views {
            font-size: 0.7rem;
            color: var(--primary);
            margin-top: 3px;
        }
        
        /* Bookmark Page Styles */
        .bookmark-page {
            display: none;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .bookmark-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .back-to-home {
            display: inline-block;
            margin-bottom: 20px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        
        /* Novel List Page Styles */
        .genre-filter {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .genre-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .genre-tag {
            padding: 5px 15px;
            background-color: var(--light);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .genre-tag:hover, .genre-tag.active {
            background-color: var(--primary);
            color: white;
        }
        
        .novel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .novel-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .novel-card:hover {
            transform: translateY(-5px);
        }
        
        .bookmark-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #f1c40f;
            font-size: 1.5rem;
            z-index: 1;
            display: none;
        }
        
        .novel-card.bookmarked .bookmark-icon {
            display: block;
        }
        
        .novel-cover {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }
        
        .novel-info {
            padding: 15px;
        }
        
        .novel-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .novel-author {
            color: #7f8c8d;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }
        
        .novel-genres {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .novel-genre {
            background-color: var(--light);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            color: var(--secondary);
        }
        
        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            gap: 10px;
        }
        
        .page-btn {
            padding: 8px 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .page-btn:hover {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .page-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Novel Detail Page Styles */
        .novel-detail-container {
            display: none;
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .novel-detail-header {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .novel-detail-cover {
            width: 250px;
            height: 350px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .novel-detail-info {
            flex: 1;
        }
        
        .novel-detail-title {
            font-size: 2rem;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .novel-detail-alt-title {
            color: #7f8c8d;
            font-size: 1.2rem;
            font-style: italic;
            margin-bottom: 5px;
        }
        
        .novel-detail-author {
            font-size: 1.2rem;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        
        .novel-detail-genres {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .novel-detail-genre {
            background-color: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .novel-detail-synopsis {
            line-height: 1.8;
            margin-bottom: 30px;
        }
        
        /* Updated Button Layout - Vertical */
        .novel-detail-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 30px;
            width: 200px;
        }
        
        .novel-detail-donate {
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .add-chapter-btn, .bookmark-novel-btn {
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            text-align: center;
        }
        
        .add-chapter-btn {
            background-color: #2ecc71;
        }
        
        .bookmark-novel-btn {
            background-color: #f39c12;
        }
        
        .bookmark-novel-btn.bookmarked {
            background-color: #000000;
            color: white;
        }
        
        /* Chapter List Styles with Read/Unread Indicator */
        .chapter-list {
            margin-top: 30px;
        }
        
        .chapter-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chapter-item.read {
            background-color: #f8f9fa;
        }
        
        .chapter-item:hover {
            background-color: var(--light);
        }
        
        .chapter-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        
        .read-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #2ecc71;
            margin-right: 10px;
            display: none;
        }
        
        .chapter-item.read .read-indicator {
            display: block;
        }
        
        .chapter-title {
            font-weight: 500;
        }
        
        .chapter-number {
            color: #7f8c8d;
            font-size: 0.8rem;
            min-width: 70px;
            text-align: right;
        }
        
        /* Add Chapter Form */
        .add-chapter-form {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* Reader Styles */
        .reader-container {
            display: none;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .reader-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .reader-title {
            font-size: 1.5rem;
            color: var(--secondary);
        }
        
        .close-reader {
            padding: 8px 15px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .reader-content {
            line-height: 1.8;
            font-size: 1.1rem;
            margin-bottom: 30px;
            white-space: pre-line;
        }
        
        .chapter-image {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 20px auto;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .chapter-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .chapter-nav-btn {
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .chapter-nav-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        /* Upload Section */
        .upload-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 30px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, 
        .form-group textarea, 
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .genre-select {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .genre-option {
            display: flex;
            align-items: center;
        }
        
        .upload-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .upload-btn:hover {
            background-color: #c0392b;
        }
        
        /* Online Counter */
        .online-counter {
            background-color: var(--secondary);
            color: white;
            padding: 15px;
            text-align: center;
            margin-top: 30px;
            border-radius: 8px;
        }

        /* Comment Section Styles */
        .comment-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .global-like {
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .global-like img {
            width: 30px;
        }

        .like-count {
            font-size: 14px;
            color: gray;
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .comment-form input,
        .comment-form textarea,
        .comment-form button {
            padding: 8px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .comment {
            border-left: 3px solid #ddd;
            padding-left: 10px;
            margin-top: 10px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comment-actions {
            display: flex;
            gap: 10px;
            font-size: 12px;
        }

        .replies {
            margin-left: 20px;
            margin-top: 10px;
        }

        .reply-form {
            display: none;
            margin-top: 5px;
        }

        img.comment-img {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
            border-radius: 4px;
        }

        button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .search-bar {
                width: 100%;
            }
            
            .novel-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .novel-detail-header {
                flex-direction: column;
            }
            
            .novel-detail-cover {
                width: 100%;
                margin-bottom: 20px;
            }
            
            .novel-detail-actions {
                width: 100%;
            }
            
            .pagination {
                flex-wrap: wrap;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage.js"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();
    </script>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo" onclick="goToHome()">SacIND</div>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Cari judul novel...">
                    <button onclick="searchNovel()"><i class="fas fa-search"></i></button>
                </div>
                <div class="header-buttons">
                    <div class="popular-dropdown">
                        <button class="popular-btn"><i class="fas fa-fire"></i> Populer</button>
                        <div class="popular-content" id="popularNovelsDropdown">
                            <!-- Popular novels will be added here dynamically -->
                        </div>
                    </div>
                    <button class="bookmark-btn" onclick="showBookmarks()"><i class="fas fa-bookmark"></i> Bookmark</button>
                    <a href="https://saweria.co/SacInd" target="_blank" class="donate-btn">Donate</a>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container" id="mainContainer">
        <!-- Home Content (Novel List) -->
        <div id="homeContent">
            <div class="genre-filter">
                <h3>Filter Genre</h3>
                <div class="genre-tags" id="genreTags">
                    <!-- Genre tags will be added here dynamically -->
                </div>
            </div>
            
            <div class="novel-grid" id="novelsContainer">
                <!-- Novel cards will be added here dynamically -->
            </div>
            
            <!-- Pagination -->
            <div class="pagination" id="pagination">
                <!-- Page buttons will be added here dynamically -->
            </div>
            
            <div class="upload-section" id="uploadSection">
                <h2>Upload Novel Baru</h2>
                <form id="uploadForm">
                    <div class="form-group">
                        <label for="novelTitle">Judul Novel</label>
                        <input type="text" id="novelTitle" required>
                    </div>

                    <div class="form-group">
                        <label for="novelAltTitle">Judul Alternatif (Opsional)</label>
                        <input type="text" id="novelAltTitle">
                    </div>
                    
                    <div class="form-group">
                        <label for="novelAuthor">Penulis</label>
                        <input type="text" id="novelAuthor" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="novelCover">Cover Novel (Gambar)</label>
                        <input type="file" id="novelCover" accept="image/*" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="novelDesc">Deskripsi</label>
                        <textarea id="novelDesc" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Genre</label>
                        <div class="genre-select" id="genreSelect">
                            <!-- Genre options will be added here dynamically -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="novelContent">Isi Novel (Chapter Pertama)</label>
                        <textarea id="novelContent" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="chapterImage">Gambar Ilustrasi Chapter (Opsional)</label>
                        <input type="file" id="chapterImage" accept="image/*">
                    </div>
                    
                    <button type="submit" class="upload-btn">Upload Novel</button>
                </form>
            </div>
        </div>
        
        <!-- Bookmark Page -->
        <div class="bookmark-page" id="bookmarkPage">
            <div class="bookmark-header">
                <h2>Novel Bookmark</h2>
                <button class="back-to-home" onclick="goToHome()"><i class="fas fa-arrow-left"></i> Kembali ke Beranda</button>
            </div>
            <div class="novel-grid" id="bookmarkedNovelsContainer">
                <!-- Bookmarked novels will be displayed here -->
            </div>
        </div>
        
        <!-- Novel Detail Page -->
        <div class="novel-detail-container" id="novelDetailContainer">
            <a href="#" class="back-to-home" onclick="goToHome()"><i class="fas fa-arrow-left"></i> Kembali ke Beranda</a>
            
            <div class="novel-detail-header">
                <img id="novelDetailCover" class="novel-detail-cover" src="" alt="Novel Cover">
                <div class="novel-detail-info">
                    <h1 class="novel-detail-title" id="novelDetailTitle"></h1>
                    <p class="novel-detail-alt-title" id="novelDetailAltTitle"></p>
                    <p class="novel-detail-author" id="novelDetailAuthor"></p>
                    
                    <div class="novel-detail-genres" id="novelDetailGenres">
                        <!-- Genres will be added here dynamically -->
                    </div>
                    
                    <div class="novel-detail-synopsis" id="novelDetailSynopsis"></div>
                    
                    <div class="novel-detail-actions">
                        <a href="https://saweria.co/SacInd" target="_blank" class="novel-detail-donate">
                            <i class="fas fa-heart"></i> Donate
                        </a>
                        <button class="add-chapter-btn" onclick="showAddChapterForm()">
                            <i class="fas fa-plus"></i> Tambah Chapter
                        </button>
                        <button class="bookmark-novel-btn" id="bookmarkNovelBtn" onclick="toggleBookmark()">
                            <i class="fas fa-bookmark"></i> Bookmark
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Add Chapter Form -->
            <div class="add-chapter-form" id="addChapterForm">
                <h3>Tambah Chapter Baru</h3>
                <form id="chapterForm">
                    <div class="form-group">
                        <label for="newChapterTitle">Judul Chapter</label>
                        <input type="text" id="newChapterTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="newChapterContent">Isi Chapter</label>
                        <textarea id="newChapterContent" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="newChapterImage">Gambar Ilustrasi (Opsional)</label>
                        <input type="file" id="newChapterImage" accept="image/*">
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="upload-btn">Upload Chapter</button>
                        <button type="button" class="chapter-nav-btn" onclick="hideAddChapterForm()" style="background-color: #95a5a6; margin-top: 10px;">Batal</button>
                    </div>
                </form>
            </div>
            
            <div class="chapter-list" id="chapterList">
                <h3>Daftar Chapter</h3>
                <!-- Chapters will be added here dynamically -->
            </div>

            <!-- Comment Section -->
            <div class="comment-section" id="commentSection">
                <div class="global-like" onclick="toggleGlobalLike()">
                    ❤️<br>
                    <span id="likeCount">0</span> orang menyukai novel ini
                </div>

                <form class="comment-form" id="mainCommentForm">
                    <input type="text" id="username" placeholder="Nama Anda (unik)" required minlength="2">
                    <textarea id="commentText" placeholder="Tulis komentar..." required></textarea>
                    <input type="file" id="commentImage" accept="image/*">
                    <button type="submit">Kirim Komentar</button>
                </form>

                <div id="commentsList"></div>
            </div>
        </div>
        
        <!-- Reader Container -->
        <div class="reader-container" id="readerContainer">
            <div class="reader-header">
                <h2 class="reader-title" id="readerTitle"></h2>
                <button class="close-reader" onclick="closeReader()">Tutup</button>
            </div>
            <div class="reader-content" id="readerContent"></div>
            
            <div class="chapter-nav">
                <button class="chapter-nav-btn" id="prevChapterBtn" onclick="navigateChapter(-1)">
                    <i class="fas fa-arrow-left"></i> Sebelumnya
                </button>
                <button class="chapter-nav-btn" id="nextChapterBtn" onclick="navigateChapter(1)">
                    Selanjutnya <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
        
        <!-- Online Counter -->
        <div class="online-counter">
            <p>Pengunjung Online: <span id="onlineCount">0</span></p>
        </div>
    </div>

    <script>
        // Available genres (including new requested genres)
        const genres = [
            'Action', 'Fantasy', 'Comedy', 'Murim', 
            'Korea', 'China', 'Sci-fi', 'Mystery', 
            'Santai', 'Balas Dendam', 'Regressi', 
            'Game', 'Gender Bender', 'Tamat', 
            'Transmigrasi', 'Romance', 'Harem',
            'Male MC', 'Female MC', 'Academy',
            'Drama', 'Demon', 'School Life', 'Hunter',
            'Horror'
        ];
        
        // Initialize with empty novels array
        let novels = [];
        
        // DOM elements
        const homeContent = document.getElementById('homeContent');
        const novelDetailContainer = document.getElementById('novelDetailContainer');
        const novelsContainer = document.getElementById('novelsContainer');
        const paginationContainer = document.getElementById('pagination');
        const uploadForm = document.getElementById('uploadForm');
        const readerContainer = document.getElementById('readerContainer');
        const readerTitle = document.getElementById('readerTitle');
        const readerContent = document.getElementById('readerContent');
        const searchInput = document.getElementById('searchInput');
        const genreTagsContainer = document.getElementById('genreTags');
        const genreSelectContainer = document.getElementById('genreSelect');
        const onlineCountElement = document.getElementById('onlineCount');
        const novelDetailTitle = document.getElementById('novelDetailTitle');
        const novelDetailAltTitle = document.getElementById('novelDetailAltTitle');
        const novelDetailAuthor = document.getElementById('novelDetailAuthor');
        const novelDetailCover = document.getElementById('novelDetailCover');
        const novelDetailSynopsis = document.getElementById('novelDetailSynopsis');
        const novelDetailGenres = document.getElementById('novelDetailGenres');
        const chapterList = document.getElementById('chapterList');
        const addChapterForm = document.getElementById('addChapterForm');
        const chapterForm = document.getElementById('chapterForm');
        const prevChapterBtn = document.getElementById('prevChapterBtn');
        const nextChapterBtn = document.getElementById('nextChapterBtn');
        const bookmarkPage = document.getElementById('bookmarkPage');
        const bookmarkedNovelsContainer = document.getElementById('bookmarkedNovelsContainer');
        const bookmarkNovelBtn = document.getElementById('bookmarkNovelBtn');
        const popularNovelsDropdown = document.getElementById('popularNovelsDropdown');
        const commentsList = document.getElementById("commentsList");
        const mainCommentForm = document.getElementById("mainCommentForm");
        const likeCountEl = document.getElementById("likeCount");
        
        // App state
        let selectedGenres = [];
        let currentNovel = null;
        let currentChapterIndex = 0;
        let onlineUsers = Math.floor(Math.random() * 100) + 50;
        let bookmarkedNovels = JSON.parse(localStorage.getItem('bookmarkedNovels')) || [];
        let readChapters = JSON.parse(localStorage.getItem('readChapters')) || [];
        let novelViews = JSON.parse(localStorage.getItem('novelViews')) || {};
        let currentPage = 1;
        const novelsPerPage = 20;
        
        // Initialize the page
        function init() {
            displayGenres();
            loadNovelsFromFirebase();
            updateOnlineCounter();
            updatePopularNovels();
            
            setInterval(updateOnlineCounter, 30000);
        }
        
        // Load novels from Firebase
        function loadNovelsFromFirebase() {
            db.collection("novels").get().then((querySnapshot) => {
                novels = [];
                querySnapshot.forEach((doc) => {
                    const novel = doc.data();
                    novel.id = doc.id;
                    novels.push(novel);
                });
                displayNovelsByPage(currentPage);
            });
        }
        
        // Display novels with pagination
        function displayNovelsByPage(page) {
            currentPage = page;
            const startIndex = (page - 1) * novelsPerPage;
            const endIndex = startIndex + novelsPerPage;
            const novelsToDisplay = novels.slice(startIndex, endIndex);
            
            displayNovels(novelsToDisplay);
            setupPagination();
        }
        
        // Setup pagination buttons
        function setupPagination() {
            const totalPages = Math.ceil(novels.length / novelsPerPage);
            paginationContainer.innerHTML = '';
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.className = `page-btn ${currentPage === 1 ? 'disabled' : ''}`;
            prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevButton.onclick = () => {
                if (currentPage > 1) {
                    displayNovelsByPage(currentPage - 1);
                }
            };
            paginationContainer.appendChild(prevButton);
            
            // Page buttons
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                const firstPageButton = document.createElement('button');
                firstPageButton.className = 'page-btn';
                firstPageButton.textContent = '1';
                firstPageButton.onclick = () => displayNovelsByPage(1);
                paginationContainer.appendChild(firstPageButton);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '8px 15px';
                    paginationContainer.appendChild(ellipsis);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageButton.textContent = i;
                pageButton.onclick = () => displayNovelsByPage(i);
                paginationContainer.appendChild(pageButton);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '8px 15px';
                    paginationContainer.appendChild(ellipsis);
                }
                
                const lastPageButton = document.createElement('button');
                lastPageButton.className = 'page-btn';
                lastPageButton.textContent = totalPages;
                lastPageButton.onclick = () => displayNovelsByPage(totalPages);
                paginationContainer.appendChild(lastPageButton);
            }
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.className = `page-btn ${currentPage === totalPages ? 'disabled' : ''}`;
            nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextButton.onclick = () => {
                if (currentPage < totalPages) {
                    displayNovelsByPage(currentPage + 1);
                }
            };
            paginationContainer.appendChild(nextButton);
        }
        
        // Display available genres
        function displayGenres() {
            // Add genre tags for filtering
            genreTagsContainer.innerHTML = '';
            
            genres.forEach(genre => {
                const genreTag = document.createElement('div');
                genreTag.className = 'genre-tag';
                genreTag.textContent = genre;
                genreTag.onclick = () => toggleGenreFilter(genre);
                genreTagsContainer.appendChild(genreTag);
            });
            
            // Add genre checkboxes for upload form
            genreSelectContainer.innerHTML = '';
            
            genres.forEach(genre => {
                const genreOption = document.createElement('div');
                genreOption.className = 'genre-option';
                
                genreOption.innerHTML = `
                    <input type="checkbox" id="genre-${genre}" name="genres" value="${genre}">
                    <label for="genre-${genre}">${genre}</label>
                `;
                
                genreSelectContainer.appendChild(genreOption);
            });
        }
        
        // Toggle genre filter
        function toggleGenreFilter(genre) {
            const genreTag = [...genreTagsContainer.children].find(
                tag => tag.textContent === genre
            );
            
            if (selectedGenres.includes(genre)) {
                selectedGenres = selectedGenres.filter(g => g !== genre);
                genreTag.classList.remove('active');
            } else {
                selectedGenres.push(genre);
                genreTag.classList.add('active');
            }
            
            filterNovels();
        }
        
        // Filter novels based on selected genres and search term
        function filterNovels() {
            const searchTerm = searchInput.value.toLowerCase();
            
            let filteredNovels = novels;
            
            // Filter by selected genres
            if (selectedGenres.length > 0) {
                filteredNovels = filteredNovels.filter(novel =>
                    selectedGenres.every(genre => 
                        novel.genres.includes(genre)
                    )
                );
            }
            
            // Filter by search term
            if (searchTerm) {
                filteredNovels = filteredNovels.filter(novel =>
                    novel.title.toLowerCase().includes(searchTerm) || 
                    novel.author.toLowerCase().includes(searchTerm)
                );
            }
            
            // Reset to page 1 when filtering
            currentPage = 1;
            novels = filteredNovels;
            displayNovelsByPage(currentPage);
        }
        
        // Display novels
        function displayNovels(novelsToDisplay) {
            novelsContainer.innerHTML = '';
            
            if (novelsToDisplay.length === 0) {
                novelsContainer.innerHTML = '<p>Tidak ada novel yang ditemukan.</p>';
                return;
            }
            
            novelsToDisplay.forEach(novel => {
                const novelCard = document.createElement('div');
                novelCard.className = 'novel-card';
                if (bookmarkedNovels.includes(novel.id)) {
                    novelCard.classList.add('bookmarked');
                }
                novelCard.onclick = () => showNovelDetail(novel.id);
                
                novelCard.innerHTML = `
                    <i class="fas fa-bookmark bookmark-icon"></i>
                    <img src="${novel.cover}" alt="${novel.title}" class="novel-cover">
                    <div class="novel-info">
                        <h3 class="novel-title">${novel.title}</h3>
                        ${novel.altTitle ? `<p class="novel-alt-title">${novel.altTitle}</p>` : ''}
                        <p class="novel-author">Oleh: ${novel.author}</p>
                        <div class="novel-genres">
                            ${novel.genres.slice(0, 3).map(genre => 
                                `<span class="novel-genre">${genre}</span>`
                            ).join('')}
                            ${novel.genres.length > 3 ? 
                                `<span class="novel-genre">+${novel.genres.length - 3}</span>` : ''}
                        </div>
                    </div>
                `;
                
                novelsContainer.appendChild(novelCard);
            });
        }
        
        // Show novel detail page
        function showNovelDetail(novelId) {
            // Track novel view
            novelViews[novelId] = (novelViews[novelId] || 0) + 1;
            localStorage.setItem('novelViews', JSON.stringify(novelViews));
            updatePopularNovels();
            
            const novel = novels.find(n => n.id === novelId);
            if (novel) {
                currentNovel = novel;
                currentChapterIndex = 0;
                
                // Update novel detail
                novelDetailTitle.textContent = novel.title;
                novelDetailAltTitle.textContent = novel.altTitle ? `(${novel.altTitle})` : '';
                novelDetailAuthor.textContent = `Oleh: ${novel.author}`;
                novelDetailCover.src = novel.cover;
                novelDetailSynopsis.textContent = novel.desc;
                
                // Update genres
                novelDetailGenres.innerHTML = '';
                novel.genres.forEach(genre => {
                    const genreTag = document.createElement('span');
                    genreTag.className = 'novel-detail-genre';
                    genreTag.textContent = genre;
                    novelDetailGenres.appendChild(genreTag);
                });
                
                // Update bookmark button state
                updateBookmarkButton();
                
                // Update chapters
                updateChapterList();
                
                // Update comments and likes
                updateCommentSection();
                
                // Show detail page
                homeContent.style.display = 'none';
                novelDetailContainer.style.display = 'block';
                readerContainer.style.display = 'none';
                addChapterForm.style.display = 'none';
                bookmarkPage.style.display = 'none';
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        // Update comment section for current novel
        function updateCommentSection() {
            if (!currentNovel) return;
            
            // Update like count
            likeCountEl.textContent = currentNovel.likes || 0;
            
            // Clear comments
            commentsList.innerHTML = '';
            
            // Add existing comments
            currentNovel.comments.forEach(comment => {
                createCommentElement(comment);
            });
        }
        
        // Create comment element
        function createCommentElement(comment) {
            const commentDiv = document.createElement("div");
            commentDiv.className = "comment";
            
            const likeBtn = document.createElement("button");
            likeBtn.textContent = `👍 ${comment.likes || 0}`;
            likeBtn.onclick = () => handleCommentReaction(comment, 'like');
            if (comment.likedUsers && comment.likedUsers.length > 0) {
                likeBtn.classList.add("disabled");
            }
            
            const dislikeBtn = document.createElement("button");
            dislikeBtn.textContent = `👎 ${comment.dislikes || 0}`;
            dislikeBtn.onclick = () => handleCommentReaction(comment, 'dislike');
            if (comment.dislikedUsers && comment.dislikedUsers.length > 0) {
                dislikeBtn.classList.add("disabled");
            }
            
            const replyBtn = document.createElement("button");
            replyBtn.textContent = "💬 Balas";
            
            const replyForm = document.createElement("form");
            replyForm.className = "reply-form";
            replyForm.innerHTML = `
                <input type="text" placeholder="Nama Anda" required>
                <textarea placeholder="Balasan..."></textarea>
                <input type="file" accept="image/*">
                <button type="submit">Kirim Balasan</button>
            `;
            
            const repliesContainer = document.createElement("div");
            repliesContainer.className = "replies";
            
            replyBtn.onclick = () => {
                replyForm.style.display = replyForm.style.display === "none" ? "block" : "none";
            };
            
            replyForm.onsubmit = function(e) {
                e.preventDefault();
                const replyUsername = replyForm.querySelector("input[type=text]").value.trim();
                const replyText = replyForm.querySelector("textarea").value.trim();
                const replyImageInput = replyForm.querySelector("input[type=file]");
                
                if (!replyUsername || !replyText) return alert("Isi nama dan balasan.");
                
                if (checkUsernameExists(replyUsername)) return alert("Nama sudah dipakai!");
                
                const replyReader = new FileReader();
                let replyImageUrl = "";
                
                replyReader.onload = function(event) {
                    replyImageUrl = event.target.result;
                    const reply = {
                        username: replyUsername,
                        text: replyText,
                        image: replyImageUrl,
                        likes: 0,
                        dislikes: 0,
                        likedUsers: [],
                        dislikedUsers: [],
                        replies: []
                    };
                    
                    if (!comment.replies) comment.replies = [];
                    comment.replies.push(reply);
                    
                    createReplyElement(reply, repliesContainer);
                    replyForm.reset();
                    replyForm.style.display = "none";
                };
                
                if (replyImageInput.files[0]) {
                    replyReader.readAsDataURL(replyImageInput.files[0]);
                } else {
                    const reply = {
                        username: replyUsername,
                        text: replyText,
                        image: "",
                        likes: 0,
                        dislikes: 0,
                        likedUsers: [],
                        dislikedUsers: [],
                        replies: []
                    };
                    
                    if (!comment.replies) comment.replies = [];
                    comment.replies.push(reply);
                    
                    createReplyElement(reply, repliesContainer);
                    replyForm.style.display = "none";
                }
            };
            
            commentDiv.innerHTML = `<strong>${comment.username}</strong>: ${comment.text}`;
            
            if (comment.image) {
                const img = document.createElement("img");
                img.src = comment.image;
                img.className = "comment-img";
                commentDiv.appendChild(img);
            }
            
            const actions = document.createElement("div");
            actions.className = "comment-actions";
            actions.appendChild(likeBtn);
            actions.appendChild(dislikeBtn);
            actions.appendChild(replyBtn);
            
            commentDiv.appendChild(actions);
            commentDiv.appendChild(replyForm);
            commentDiv.appendChild(repliesContainer);
            
            // Add replies if they exist
            if (comment.replies && comment.replies.length > 0) {
                comment.replies.forEach(reply => {
                    createReplyElement(reply, repliesContainer);
                });
            }
            
            commentsList.appendChild(commentDiv);
        }
        
        // Create reply element
        function createReplyElement(reply, container) {
            const replyDiv = document.createElement("div");
            replyDiv.className = "comment";
            
            const likeBtn = document.createElement("button");
            likeBtn.textContent = `👍 ${reply.likes || 0}`;
            likeBtn.onclick = () => handleCommentReaction(reply, 'like');
            if (reply.likedUsers && reply.likedUsers.length > 0) {
                likeBtn.classList.add("disabled");
            }
            
            const dislikeBtn = document.createElement("button");
            dislikeBtn.textContent = `👎 ${reply.dislikes || 0}`;
            dislikeBtn.onclick = () => handleCommentReaction(reply, 'dislike');
            if (reply.dislikedUsers && reply.dislikedUsers.length > 0) {
                dislikeBtn.classList.add("disabled");
            }
            
            replyDiv.innerHTML = `<strong>${reply.username}</strong>: ${reply.text}`;
            
            if (reply.image) {
                const img = document.createElement("img");
                img.src = reply.image;
                img.className = "comment-img";
                replyDiv.appendChild(img);
            }
            
            const actions = document.createElement("div");
            actions.className = "comment-actions";
            actions.appendChild(likeBtn);
            actions.appendChild(dislikeBtn);
            
            replyDiv.appendChild(actions);
            container.appendChild(replyDiv);
        }
        
        // Handle comment reactions (like/dislike)
        function handleCommentReaction(comment, type) {
            const username = prompt("Masukkan nama Anda untuk memberikan reaksi:");
            if (!username) return;
            
            if (type === 'like') {
                if (comment.likedUsers && comment.likedUsers.includes(username)) {
                    alert("Anda sudah memberikan like pada komentar ini.");
                    return;
                }
                if (comment.dislikedUsers && comment.dislikedUsers.includes(username)) {
                    alert("Anda sudah memberikan dislike pada komentar ini.");
                    return;
                }
                
                comment.likes = (comment.likes || 0) + 1;
                if (!comment.likedUsers) comment.likedUsers = [];
                comment.likedUsers.push(username);
            } else {
                if (comment.dislikedUsers && comment.dislikedUsers.includes(username)) {
                    alert("Anda sudah memberikan dislike pada komentar ini.");
                    return;
                }
                if (comment.likedUsers && comment.likedUsers.includes(username)) {
                    alert("Anda sudah memberikan like pada komentar ini.");
                    return;
                }
                
                comment.dislikes = (comment.dislikes || 0) + 1;
                if (!comment.dislikedUsers) comment.dislikedUsers = [];
                comment.dislikedUsers.push(username);
            }
            
            // Update the display
            updateCommentSection();
        }
        
        // Update popular novels dropdown
        function updatePopularNovels() {
            // Get novel views from localStorage
            const storedViews = JSON.parse(localStorage.getItem('novelViews')) || {};
            
            // Add view count to each novel and sort by views (descending)
            const popularNovels = novels.map(novel => ({
                ...novel,
                views: storedViews[novel.id] || 0
            })).sort((a, b) => b.views - a.views).slice(0, 6); // Get top 6
            
            const dropdown = document.getElementById('popularNovelsDropdown');
            dropdown.innerHTML = '';
            
            if (popularNovels.length === 0) {
                dropdown.innerHTML = '<p style="padding: 10px; text-align: center;">Belum ada data novel populer</p>';
                return;
            }
            
            popularNovels.forEach(novel => {
                const novelElement = document.createElement('div');
                novelElement.className = 'popular-novel';
                novelElement.onclick = () => {
                    // Increment view count when clicked from dropdown
                    novelViews[novel.id] = (novelViews[novel.id] || 0) + 1;
                    localStorage.setItem('novelViews', JSON.stringify(novelViews));
                    showNovelDetail(novel.id);
                };
                
                novelElement.innerHTML = `
                    <img src="${novel.cover}" alt="${novel.title}" class="popular-novel-cover">
                    <div class="popular-novel-info">
                        <div class="popular-novel-title">${novel.title}</div>
                        <div class="popular-novel-author">${novel.author}</div>
                        <div class="popular-novel-views">${novel.views} kali dibaca</div>
                    </div>
                `;
                
                dropdown.appendChild(novelElement);
            });
        }
        
        // Update bookmark button state
        function updateBookmarkButton() {
            if (!currentNovel) return;
            
            if (bookmarkedNovels.includes(currentNovel.id)) {
                bookmarkNovelBtn.innerHTML = '<i class="fas fa-bookmark"></i> Bookmarked';
                bookmarkNovelBtn.classList.add('bookmarked');
            } else {
                bookmarkNovelBtn.innerHTML = '<i class="fas fa-bookmark"></i> Bookmark';
                bookmarkNovelBtn.classList.remove('bookmarked');
            }
        }
        
        // Toggle bookmark for current novel
        function toggleBookmark() {
            if (!currentNovel) return;
            
            const index = bookmarkedNovels.indexOf(currentNovel.id);
            if (index === -1) {
                bookmarkedNovels.push(currentNovel.id);
            } else {
                bookmarkedNovels.splice(index, 1);
            }
            
            // Save to localStorage
            localStorage.setItem('bookmarkedNovels', JSON.stringify(bookmarkedNovels));
            
            // Update button and novel cards
            updateBookmarkButton();
            displayNovelsByPage(currentPage);
        }
        
        // Show bookmarked novels
        function showBookmarks() {
            homeContent.style.display = 'none';
            novelDetailContainer.style.display = 'none';
            readerContainer.style.display = 'none';
            bookmarkPage.style.display = 'block';
            
            // Display bookmarked novels
            bookmarkedNovelsContainer.innerHTML = '';
            
            if (bookmarkedNovels.length === 0) {
                bookmarkedNovelsContainer.innerHTML = '<p>Anda belum menandai novel apapun.</p>';
                return;
            }
            
            const bookmarkedNovelsData = novels.filter(novel => 
                bookmarkedNovels.includes(novel.id)
            );
            
            bookmarkedNovelsData.forEach(novel => {
                const novelCard = document.createElement('div');
                novelCard.className = 'novel-card bookmarked';
                novelCard.onclick = () => showNovelDetail(novel.id);
                
                novelCard.innerHTML = `
                    <i class="fas fa-bookmark bookmark-icon"></i>
                    <img src="${novel.cover}" alt="${novel.title}" class="novel-cover">
                    <div class="novel-info">
                        <h3 class="novel-title">${novel.title}</h3>
                        ${novel.altTitle ? `<p class="novel-alt-title">${novel.altTitle}</p>` : ''}
                        <p class="novel-author">Oleh: ${novel.author}</p>
                        <div class="novel-genres">
                            ${novel.genres.slice(0, 3).map(genre => 
                                `<span class="novel-genre">${genre}</span>`
                            ).join('')}
                            ${novel.genres.length > 3 ? 
                                `<span class="novel-genre">+${novel.genres.length - 3}</span>` : ''}
                        </div>
                    </div>
                `;
                
                bookmarkedNovelsContainer.appendChild(novelCard);
            });
        }
        
        // Update chapter list display
        function updateChapterList() {
            chapterList.innerHTML = '<h3>Daftar Chapter</h3>';
            
            currentNovel.chapters.forEach((chapter, index) => {
                const chapterKey = `${currentNovel.id}-${chapter.id}`;
                const isRead = readChapters.includes(chapterKey);
                
                const chapterItem = document.createElement('div');
                chapterItem.className = `chapter-item ${isRead ? 'read' : ''}`;
                chapterItem.innerHTML = `
                    <div class="chapter-info">
                        <div class="read-indicator"></div>
                        <div class="chapter-title">${chapter.title}</div>
                    </div>
                    <div class="chapter-number">Chapter ${index + 1}</div>
                `;
                chapterItem.onclick = () => readChapter(index);
                chapterList.appendChild(chapterItem);
            });
        }
        
        // Read a chapter
        function readChapter(chapterIndex) {
            if (!currentNovel || chapterIndex < 0 || chapterIndex >= currentNovel.chapters.length) return;
            
            currentChapterIndex = chapterIndex;
            const chapter = currentNovel.chapters[chapterIndex];
            
            // Mark chapter as read
            const chapterKey = `${currentNovel.id}-${chapter.id}`;
            if (!readChapters.includes(chapterKey)) {
                readChapters.push(chapterKey);
                localStorage.setItem('readChapters', JSON.stringify(readChapters));
            }
            
            readerTitle.textContent = `${currentNovel.title} - ${chapter.title}`;
            
            // Clear previous content
            readerContent.innerHTML = '';
            
            // Add chapter image if exists
            if (chapter.image) {
                const img = document.createElement('img');
                img.src = chapter.image;
                img.className = 'chapter-image';
                img.alt = `Illustrasi ${chapter.title}`;
                readerContent.appendChild(img);
            }
            
            // Add chapter content
            const content = document.createElement('div');
            content.textContent = chapter.content;
            readerContent.appendChild(content);
            
            // Update navigation buttons
            prevChapterBtn.disabled = chapterIndex === 0;
            nextChapterBtn.disabled = chapterIndex === currentNovel.chapters.length - 1;
            
            // Show reader
            novelDetailContainer.style.display = 'none';
            readerContainer.style.display = 'block';
            bookmarkPage.style.display = 'none';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Update chapter list to reflect read status
            updateChapterList();
        }
        
        // Navigate between chapters
        function navigateChapter(direction) {
            const newIndex = currentChapterIndex + direction;
            if (newIndex >= 0 && newIndex < currentNovel.chapters.length) {
                readChapter(newIndex);
            }
        }
        
        // Show add chapter form
        function showAddChapterForm() {
            addChapterForm.style.display = 'block';
            chapterForm.reset();
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }
        
        // Hide add chapter form
        function hideAddChapterForm() {
            addChapterForm.style.display = 'none';
        }
        
        // Close reader
        function closeReader() {
            if (currentNovel) {
                readerContainer.style.display = 'none';
                novelDetailContainer.style.display = 'block';
            } else {
                readerContainer.style.display = 'none';
                homeContent.style.display = 'block';
            }
        }
        
        // Handle novel form submission
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('novelTitle').value;
            const altTitle = document.getElementById('novelAltTitle').value;
            const author = document.getElementById('novelAuthor').value;
            const coverFile = document.getElementById('novelCover').files[0];
            const desc = document.getElementById('novelDesc').value;
            const content = document.getElementById('novelContent').value;
            const chapterImageFile = document.getElementById('chapterImage').files[0];
            
            // Get selected genres
            const genreCheckboxes = document.querySelectorAll('input[name="genres"]:checked');
            const selectedGenres = Array.from(genreCheckboxes).map(cb => cb.value);
            
            // Validate at least one genre is selected
            if (selectedGenres.length === 0) {
                alert('Pilih minimal satu genre!');
                return;
            }
            
            // Create a preview URL for the uploaded image
            const coverUrl = coverFile ? URL.createObjectURL(coverFile) : 'https://via.placeholder.com/250x350';
            const chapterImageUrl = chapterImageFile ? URL.createObjectURL(chapterImageFile) : null;
            
            // Create new novel object with first chapter
            const newNovel = {
                title,
                altTitle: altTitle || null,
                author,
                cover: coverUrl,
                desc,
                genres: selectedGenres,
                chapters: [
                    {
                        id: 1,
                        title: "Chapter 1",
                        content: content,
                        image: chapterImageUrl
                    }
                ],
                comments: [],
                likes: 0,
                likers: []
            };
            
            // Add to novels array
            novels.unshift(newNovel);
            
            // Refresh display
            filterNovels();
            
            // Reset form
            uploadForm.reset();
            
            alert('Novel berhasil diupload!');
        });
        
        // Handle chapter form submission
        chapterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('newChapterTitle').value;
            const content = document.getElementById('newChapterContent').value;
            const imageFile = document.getElementById('newChapterImage').files[0];
            
            if (!currentNovel) return;
            
            // Create new chapter object
            const newChapter = {
                id: currentNovel.chapters.length + 1,
                title,
                content,
                image: imageFile ? URL.createObjectURL(imageFile) : null
            };
            
            // Add to current novel's chapters
            currentNovel.chapters.push(newChapter);
            
            // Update display
            updateChapterList();
            
            // Hide form and reset
            addChapterForm.style.display = 'none';
            chapterForm.reset();
            
            alert('Chapter berhasil ditambahkan!');
        });
        
        // Handle comment form submission
        mainCommentForm.addEventListener("submit", function(e) {
            e.preventDefault();
            const username = document.getElementById("username").value.trim();
            const commentText = document.getElementById("commentText").value.trim();
            const imageInput = document.getElementById("commentImage");
            
            if (!username || !commentText) return alert("Isi nama dan komentar dulu.");
            if (checkUsernameExists(username)) return alert("Nama sudah dipakai!");
            
            const reader = new FileReader();
            let imageUrl = "";
            
            reader.onload = function(event) {
                imageUrl = event.target.result;
                const comment = {
                    username,
                    text: commentText,
                    image: imageUrl,
                    likes: 0,
                    dislikes: 0,
                    likedUsers: [],
                    dislikedUsers: [],
                    replies: []
                };
                
                currentNovel.comments.push(comment);
                createCommentElement(comment);
                mainCommentForm.reset();
            };
            
            if (imageInput.files[0]) {
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                const comment = {
                    username,
                    text: commentText,
                    image: "",
                    likes: 0,
                    dislikes: 0,
                    likedUsers: [],
                    dislikedUsers: [],
                    replies: []
                };
                
                currentNovel.comments.push(comment);
                createCommentElement(comment);
                mainCommentForm.reset();
            }
        });
        
        // Check if username exists in comments
        function checkUsernameExists(name) {
            if (!currentNovel || !currentNovel.comments) return false;
            
            // Check main comments
            for (const comment of currentNovel.comments) {
                if (comment.username === name) return true;
                
                // Check replies
                if (comment.replies) {
                    for (const reply of comment.replies) {
                        if (reply.username === name) return true;
                    }
                }
            }
            return false;
        }
        
        // Toggle global like for novel
        function toggleGlobalLike() {
            if (!currentNovel) return;
            
            const username = prompt("Masukkan nama Anda untuk memberikan like:");
            if (!username) return;
            
            if (currentNovel.likers && currentNovel.likers.includes(username)) {
                alert("Anda sudah pernah memberikan like pada novel ini.");
                return;
            }
            
            currentNovel.likes = (currentNovel.likes || 0) + 1;
            if (!currentNovel.likers) currentNovel.likers = [];
            currentNovel.likers.push(username);
            
            likeCountEl.textContent = currentNovel.likes;
        }
        
        // Search novels
        function searchNovel() {
            filterNovels();
        }
        
        // Go to home
        function goToHome() {
            currentNovel = null;
            currentChapterIndex = 0;
            selectedGenres = [];
            document.querySelectorAll('.genre-tag').forEach(tag => {
                tag.classList.remove('active');
            });
            searchInput.value = '';
            
            homeContent.style.display = 'block';
            novelDetailContainer.style.display = 'none';
            readerContainer.style.display = 'none';
            bookmarkPage.style.display = 'none';
            
            displayNovelsByPage(1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Update online counter
        function updateOnlineCounter() {
            // Simulate changing online users
            onlineUsers += Math.floor(Math.random() * 10) - 5;
            onlineUsers = Math.max(50, onlineUsers); // Keep minimum 50
            
            onlineCountElement.textContent = onlineUsers;
        }
        
        // Initialize the page
        init();
    </script>
</body>
</html>